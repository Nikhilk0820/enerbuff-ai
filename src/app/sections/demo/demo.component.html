<section id="demo" class="container" style="padding: 18px 0 42px">
  <h2 class="h2" style="margin-bottom: 14px">
    ISTS Drawal Forecasting (Managing DSM Penalty Risk)
  </h2>
  <h5 class="h3" style="margin-bottom: 14px; color: rgb(125 250 197);">
    “Following below steps is mandatory to ensure accurate forecasting.”
  </h5>
  <div
    class="steps-wrapper"
    style="
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 18px;
      align-items: start;
    "
  >
    <aside class="panel setup-steps" style="position: sticky; top: 100px">
      <h3 class="setup-steps__title">Setup Steps</h3>

      <div
        class="setup-step"
        [class.is-active]="currentStep === 1"
        (click)="goToStep(1)"
      >
        <div class="setup-step__meta">
          <span class="setup-step__label">Step 1</span>
          <span class="setup-step__desc">Template Preparation</span>
        </div>
        <span class="setup-step__status" *ngIf="stepOneComplete">Done</span>
      </div>

      <div
        class="setup-step"
        [class.is-active]="currentStep === 2"
        [class.is-disabled]="isStepTwoLocked"
        (click)="goToStep(2)"
      >
        <div class="setup-step__meta">
          <span class="setup-step__label">Step 2</span>
          <span class="setup-step__desc">Upload Historical Data</span>
        </div>
        <span class="setup-step__status" *ngIf="stepTwoComplete">Done</span>
      </div>

      <div
        class="setup-step"
        [class.is-active]="currentStep === 3"
        [class.is-disabled]="isStepThreeLocked"
        (click)="goToStep(3)"
      >
        <div class="setup-step__meta">
          <span class="setup-step__label">Step 3</span>
          <span class="setup-step__desc">Run Forecast</span>
        </div>
        <span class="setup-step__status" *ngIf="!isStepThreeLocked">Ready</span>
      </div>
    </aside>
    <div style="display: flex; flex-direction: column; gap: 18px">
      <div class="panel" style="padding: 22px">
        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 6px">
          Step 1 � Template Preparation
        </h3>
        <p class="muted" style="margin-bottom: 18px">
          Create and update the Historical Data Template in a structured format.
        </p>
        <div style="display: grid; gap: 12px; max-width: 420px">
          <div>
            <label class="muted">State (Utilities)*</label>
            <input
              type="text"
              [value]="selectedState || 'State not available'"
              style="
                width: 100%;
                padding: 10px;
                border-radius: 10px;
                background: #121820;
                border: 1px solid var(--ring);
                color: var(--text);
              "
              readonly
              disabled
            />
            <small
              *ngIf="isStateLocked && selectedState"
              class="muted"
              style="display: block; margin-top: 6px; font-size: 12px"
            >
              State comes from your registration details.
            </small>
          </div>
        </div>
        <div
          style="
            display: flex;
            gap: 10px;
            margin-top: 18px;
            align-items: center;
            flex-wrap: wrap;
          "
        >
          <button
            class="btn btn-primary"
            (click)="createTemplate()"
            [disabled]="templateLoading || !selectedState || !user"
            [title]="!user ? 'Please login to avail this feature' : ''"
          >
            {{ templateLoading ? "Creating..." : "Create Template" }}
          </button>
          <button
            class="btn"
            (click)="downloadTemplate()"
            [disabled]="!templateDownloadUrl"
          >
            Download Template
          </button>
          <button class="btn" (click)="useExistingTemplate()">
            User already having template
          </button>
        </div>
        <span
          class="muted"
          *ngIf="!user"
          style="
            color: #ff6b6b;
            font-weight: 600;
            font-size: 15px;
            margin-top: 12px;
            display: inline-block;
          "
          >Please login to avail this feature</span
        >
        <div
          *ngIf="templateMessage"
          style="margin-top: 12px; font-size: 14px; font-weight: 600"
          [style.color]="
            templateMessage.toLowerCase().includes('fail')
              ? '#ff6b6b'
              : '#4ade80'
          "
        >
          {{ templateMessage }}
        </div>
      </div>

      <div
        class="panel"
        style="padding: 22px; position: relative; transition: opacity 0.2s"
        [style.opacity]="isStepTwoLocked ? 0.45 : 1"
      >
        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 6px">
          Step 2 &mdash; Upload Historical Data
        </h3>
        <p class="muted" style="margin-bottom: 18px">
          Upload your filled template with the latest data. This must be
          completed before running a forecast.
        </p>

        <div class="grid grid-3" style="margin-top: 6px">
          <div>
            <label class="muted">Upload Historical data*</label>
            <input
              type="file"
              (change)="onFileChange($event, 'demand')"
              style="width: 100%"
              title="Kindly upload today's demand History."
            />
            <span
              class="muted"
              style="font-size: 12px; display: block; margin-top: 4px"
            >
              File format should be <strong>CSV</strong> or
              <strong>Excel (.xls, .xlsx)</strong>
            </span>
            <span
              *ngIf="demandFileError"
              style="
                color: #ff6b6b;
                font-size: 13px;
                display: block;
                margin-top: 4px;
              "
            >
              {{ demandFileError }}
            </span>
            <span
              *ngIf="files['demand']"
              class="muted"
              style="font-size: 12px; display: block; margin-top: 4px"
            >
              Selected: {{ files["demand"] }}
            </span>
          </div>
        </div>

        <div
          style="
            margin-top: 18px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
          "
        >
          <button
            class="btn btn-primary"
            type="button"
            (click)="uploadDailyData()"
            [disabled]="
              uploadLoading || isStepTwoLocked || !user || !demandFile
            "
            [title]="!user ? 'Please login to avail this feature' : ''"
          >
            {{ uploadLoading ? "Uploading..." : "Upload Data" }}
          </button>
        </div>

        <div
          *ngIf="uploadMessage"
          style="margin-top: 12px; font-size: 14px; font-weight: 600"
          [style.color]="
            uploadMessage.toLowerCase().includes('fail') ||
            uploadMessage.toLowerCase().includes('error')
              ? '#ff6b6b'
              : '#4ade80'
          "
        >
          {{ uploadMessage }}
        </div>

        <div
          *ngIf="isStepTwoLocked"
          style="
            position: absolute;
            inset: 0;
            background: rgba(10, 16, 23, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 18px;
            color: #cbd5f5;
            font-weight: 600;
          "
        >
          Complete Step 1 to unlock this step
        </div>
      </div>

      <div
        class="panel"
        style="padding: 22px; position: relative; transition: opacity 0.2s"
        [style.opacity]="isStepThreeLocked ? 0.45 : 1"
      >
        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 6px">
          Step 3 &mdash; Run Forecast
        </h3>
        <p class="muted" style="margin-bottom: 18px">
          Review your setup and generate AI-powered forecasts.
        </p>

        <div style="display: flex; gap: 8px; margin-bottom: 16px">
          <button
            class="btn"
            [class.btn-primary]="activeTab === 'dayahead'"
            (click)="setActiveTab('dayahead')"
          >
            Day-Ahead
          </button>
          <button
            class="btn"
            [class.btn-primary]="activeTab === 'intraday'"
            (click)="setActiveTab('intraday')"
          >
            Intra-day
          </button>
        </div>

        <div class="grid grid-3" style="margin-top: 6px">
          <div *ngIf="activeTab === 'intraday'">
            <label class="muted">Download sample file for intraday event</label>
            <button
              type="button"
              class="btn"
              (click)="downloadIntradaySample()"
              style="width: 100%; margin-top: 6px"
            >
              Download Sample
            </button>
            <span
              class="muted"
              style="font-size: 12px; display: block; margin-top: 4px"
            >
              Sample covers today in 15-min intervals with columns: timestamp,
              load
            </span>
          </div>

          <div *ngIf="activeTab === 'intraday'">
            <label class="muted">Upload Today's Actual partials data*</label>
            <input
              type="file"
              (change)="onFileChange($event, 'actual')"
              style="width: 100%"
              title="Kindly upload today's actual partials data."
            />
            <span
              class="muted"
              style="font-size: 12px; display: block; margin-top: 4px"
            >
              File format should be <strong>CSV</strong> or
              <strong>Excel (.xls, .xlsx)</strong>
            </span>
            <span
              *ngIf="activeTab === 'intraday' && !actualFile"
              style="
                color: #ff6b6b;
                font-size: 13px;
                display: block;
                margin-top: 4px;
              "
            >
              Please upload today's actual partials data.
            </span>
            <span
              *ngIf="demandFileError1"
              style="
                color: #ff6b6b;
                font-size: 13px;
                display: block;
                margin-top: 4px;
              "
            >
              {{ demandFileError1 }}
            </span>
          </div>
        </div>
        <div class="grid grid-3" style="margin-top: 6px">
          <div>
            <label class="muted">ISTS Drawal file</label>
            <input
              type="text"
              [value]="files['demand'] || 'Not uploaded yet'"
              style="
                width: 100%;
                padding: 10px;
                border-radius: 10px;
                background: #121820;
                border: 1px solid var(--ring);
                color: var(--text);
              "
              disabled
              readonly
            />
            <small
              *ngIf="isStateLocked && selectedState"
              class="muted"
              style="display: block; margin-top: 6px; font-size: 12px"
            >
              ISTS Drawal file comes from Step 2.
            </small>
          </div>

          <div>
            <label class="muted">State (Utilities)*</label>
            <input
              type="text"
              [value]="selectedState || 'State not available'"
              style="
                width: 100%;
                padding: 10px;
                border-radius: 10px;
                background: #121820;
                border: 1px solid var(--ring);
                color: var(--text);
              "
              readonly
              disabled
            />
            <small
              *ngIf="isStateLocked && selectedState"
              class="muted"
              style="display: block; margin-top: 6px; font-size: 12px"
            >
              State comes from your registration details.
            </small>
          </div>

          <div>
            <label class="muted">Date</label>
            <input
              type="text"
              [value]="dateDisplay"
              style="
                width: 100%;
                padding: 10px;
                border-radius: 10px;
                background: #121820;
                border: 1px solid var(--ring);
                color: var(--text);
              "
              disabled
            />
            <small
              *ngIf="isStateLocked && selectedState"
              class="muted"
              style="display: block; margin-top: 6px; font-size: 12px"
            >
              Date is auto selected as per event type.
            </small>
          </div>
        </div>

        <div
          style="
            display: flex;
            gap: 10px;
            margin-top: 18px;
            align-items: center;
            flex-wrap: wrap;
          "
        >
          <button
            class="btn btn-primary"
            (click)="runSynthetic()"
            [disabled]="
              isStepTwoLocked ||
              isStepThreeLocked ||
              !user ||
              loading ||
              demandFileError ||
              !selectedState ||
              !hasRequiredCredits ||
              (activeTab === 'intraday' && !actualFile)
            "
            [title]="!user ? 'Please login to avail this feature' : ''"
          >
            {{
              loading
                ? "Running..."
                : activeTab === "dayahead"
                ? "Run Day-Ahead (10 EnerCoins)"
                : "Run Intra-Day (2 EnerCoins)"
            }}
          </button>

          <button class="btn" (click)="downloadCsv()" [disabled]="!csvText">
            Download CSV
          </button>
          <span
            class="muted"
            *ngIf="!user"
            style="color: #ff6b6b; font-weight: 600; font-size: 15px"
            >Please login to avail this feature</span
          >
        </div>

        <div
          *ngIf="user && !hasRequiredCredits && !loading"
          style="margin-top: 10px; color: #ffc241; font-weight: 600"
        >
          Need {{ requiredEnerCoins }} EnerCoin for this run. Available:
          {{ availableCredits | number : "1.0-0" }}.
        </div>

        <div *ngIf="message" style="margin-top: 10px; color: #ff6b6b">
          {{ message }}
        </div>

        <div *ngIf="chart" style="margin-top: 16px">
          <svg
            [attr.viewBox]="chart.viewBox"
            style="
              width: 100%;
              height: auto;
              background: #0b0f14;
              border-radius: 8px;
            "
          >
            <!-- grid -->
            <g stroke="#1e2630" stroke-width="1">
              <ng-container *ngFor="let y of chart.gridY">
                <line x1="60" x2="880" [attr.y1]="y" [attr.y2]="y"></line>
              </ng-container>
              <ng-container *ngFor="let x of chart.gridX">
                <line [attr.x1]="x" [attr.x2]="x" y1="20" y2="310"></line>
              </ng-container>
            </g>

            <!-- axes -->
            <g stroke="#344155" stroke-width="2">
              <line x1="60" y1="310" x2="880" y2="310"></line>
              <line x1="60" y1="20" x2="60" y2="310"></line>
            </g>

            <!-- ticks labels -->
            <g fill="#9ba3af" font-size="11">
              <ng-container *ngFor="let t of chart.yTicks">
                <text x="56" [attr.y]="t.y + 4" text-anchor="end">
                  {{ t.label }}
                </text>
              </ng-container>
              <ng-container *ngFor="let t of chart.xTicks">
                <text [attr.x]="t.x" y="340" text-anchor="middle">
                  {{ t.label }}
                </text>
              </ng-container>
            </g>

            <!-- series -->
            <g fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path
                *ngFor="let s of chart.series"
                [attr.d]="s.path"
                [attr.stroke]="s.color"
                stroke-width="2.5"
                [attr.stroke-dasharray]="
                  s.name.toLowerCase().includes('pred') ||
                  s.name.toLowerCase().includes('hat')
                    ? '6,5'
                    : null
                "
              ></path>
            </g>

            <!-- legend -->
            <g font-size="12" font-weight="600">
              <ng-container *ngFor="let lg of chart.legend; let i = index">
                <rect
                  x="70"
                  [attr.y]="26 + i * 20"
                  width="14"
                  height="3"
                  [attr.fill]="lg.color"
                ></rect>
                <text x="90" [attr.y]="30 + i * 20" fill="#e5e7eb">
                  {{ lg.name }}
                </text>
              </ng-container>
            </g>
          </svg>
        </div>

        <div
          *ngIf="isStepThreeLocked"
          style="
            position: absolute;
            inset: 0;
            background: rgba(10, 16, 23, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 18px;
            color: #cbd5f5;
            font-weight: 600;
            pointer-events: auto;
          "
        >
          Complete Step 2 to unlock this step
        </div>
      </div>
    </div>
  </div>
</section>
